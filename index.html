<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoSense Live Monitor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a202c; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; 
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Map Height */
        #map {
            height: 400px;
            z-index: 1;
        }

        /* Card Transitions */
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 font-sans min-h-screen selection:bg-blue-500 selection:text-white">

    <!-- Navbar -->
    <nav class="glass sticky top-0 z-50 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center animate-pulse">
                        <i class="fa-solid fa-satellite-dish text-white text-sm"></i>
                    </div>
                    <span class="font-bold text-xl tracking-wide">EcoSense<span class="text-blue-400">Live</span></span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <span id="connection-status" class="flex items-center gap-2 text-green-400">
                        <span class="w-2 h-2 rounded-full bg-green-400"></span> Online
                    </span>
                    <span id="last-updated" class="text-slate-400 hidden sm:inline">Waiting for data...</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        
        <!-- Status Overview Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Temperature -->
            <div id="card-temp" class="stat-card glass rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fa-solid fa-temperature-three-quarters text-6xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">Temperature</span>
                    <div class="flex items-end gap-2 mt-2">
                        <span id="val-temp" class="text-4xl font-bold">--</span>
                        <span class="text-xl text-slate-500 mb-1">°C</span>
                    </div>
                    <div class="mt-4 h-1 w-full bg-slate-700 rounded-full overflow-hidden">
                        <div id="bar-temp" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div>
                    </div>
                </div>
            </div>

            <!-- Humidity -->
            <div id="card-hum" class="stat-card glass rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fa-solid fa-droplet text-6xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">Humidity</span>
                    <div class="flex items-end gap-2 mt-2">
                        <span id="val-hum" class="text-4xl font-bold">--</span>
                        <span class="text-xl text-slate-500 mb-1">%</span>
                    </div>
                    <div class="mt-4 h-1 w-full bg-slate-700 rounded-full overflow-hidden">
                        <div id="bar-hum" class="h-full bg-cyan-400 w-0 transition-all duration-1000"></div>
                    </div>
                </div>
            </div>

            <!-- UV Index -->
            <div id="card-uv" class="stat-card glass rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fa-regular fa-sun text-6xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">UV Index</span>
                    <div class="flex items-end gap-2 mt-2">
                        <span id="val-uv" class="text-4xl font-bold">--</span>
                        <span class="text-xl text-slate-500 mb-1">Idx</span>
                    </div>
                    <span id="status-uv" class="text-xs mt-2 px-2 py-1 rounded bg-slate-800 inline-block w-fit">Normal</span>
                </div>
            </div>

            <!-- Gas PPM -->
            <div id="card-gas" class="stat-card glass rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fa-solid fa-wind text-6xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">Air Quality (Gas)</span>
                    <div class="flex items-end gap-2 mt-2">
                        <span id="val-gas" class="text-4xl font-bold">--</span>
                        <span class="text-xl text-slate-500 mb-1">PPM</span>
                    </div>
                    <span id="status-gas" class="text-xs mt-2 px-2 py-1 rounded bg-slate-800 inline-block w-fit">Safe</span>
                </div>
            </div>
        </div>

        <!-- Solar & Distance Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <!-- Solar Stats (Takes up 3 cols on large) -->
            <div class="lg:col-span-3 glass rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-solar-panel text-yellow-500"></i> Solar Array Performance
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">Voltage</p>
                        <p class="text-2xl font-bold text-yellow-400"><span id="val-sol-v">--</span> <span class="text-sm text-slate-500">V</span></p>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">Current</p>
                        <p class="text-2xl font-bold text-yellow-400"><span id="val-sol-i">--</span> <span class="text-sm text-slate-500">mA</span></p>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">Power Output</p>
                        <p class="text-2xl font-bold text-green-400"><span id="val-sol-p">--</span> <span class="text-sm text-slate-500">W</span></p>
                    </div>
                </div>
                <!-- Solar Chart -->
                <div class="mt-6 h-48 w-full">
                    <canvas id="solarChart"></canvas>
                </div>
            </div>

            <!-- Distance Card -->
            <div class="glass rounded-xl p-6 flex flex-col justify-between relative overflow-hidden">
                <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-blue-500/20 rounded-full blur-2xl"></div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-ruler-horizontal text-blue-400"></i> Range
                    </h3>
                    <p class="text-slate-400 text-xs mb-4">Distance from Ground Station</p>
                </div>
                <div class="text-center py-4">
                    <span id="val-dist" class="text-5xl font-bold tracking-tighter text-white">--</span>
                    <span class="text-lg text-slate-400 block">Meters</span>
                </div>
                <div class="mt-2 text-xs text-center text-slate-500">
                    Lat: <span id="lbl-lat">--</span> <br> Lon: <span id="lbl-lon">--</span>
                </div>
            </div>
        </div>

        <!-- Charts & Map Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Environmental Chart -->
            <div class="glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-chart-line text-purple-400"></i> Environmental Trends
                    </h3>
                    <div class="flex gap-2 text-xs">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-400"></span> Temp</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> Hum</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> UV</span>
                    </div>
                </div>
                <div class="h-80 w-full">
                    <canvas id="envChart"></canvas>
                </div>
            </div>

            <!-- Map -->
            <div class="glass rounded-xl p-1 overflow-hidden flex flex-col">
                <div class="p-4 bg-slate-800/50 flex justify-between items-center">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-location-dot text-red-500"></i> Live Tracking
                    </h3>
                    <span class="text-xs bg-blue-600 px-2 py-1 rounded text-white animate-pulse">LIVE GPS</span>
                </div>
                <div id="map" class="flex-grow w-full h-full rounded-b-lg bg-slate-800 relative">
                    <!-- Map Loads Here -->
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-800 mt-12 py-8 text-center text-slate-500 text-sm">
        <p>EcoSense Dashboard &copy; 2023. Real-time Environmental Monitoring System.</p>
        <p class="mt-2">Designed and developed by 
            <a href="https://jabedshariar.vercel.app/" 
               target="_blank" 
               class="text-blue-400 hover:text-blue-300 transition-colors duration-200 font-medium underline">
               Jabed Shariar
            </a>
        </p>
    </footer>

    <script>
        // --- Configuration ---
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQie58TDrdruTe_9HevG5NGowDAix8Q0tzG2qYL26AooSA9WlRPiLFmmWFYrc82DA/pub?output=csv";
        const REFRESH_RATE = 3000; // 3 seconds
        
        // Ground Station Coordinates (Fixed)
        const GS_LAT = 23.88134963936152;
        const GS_LON = 90.32049486826592;

        // --- State ---
        let map, mobileMarker, groundMarker, polyline;
        let envChart, solarChart;
        let isFirstLoad = true;

        // --- Chart Initialization ---
        function initCharts() {
            // Environmental Chart
            const ctxEnv = document.getElementById('envChart').getContext('2d');
            envChart = new Chart(ctxEnv, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Temp (°C)', borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', data: [], tension: 0.4, fill: true },
                        { label: 'Humidity (%)', borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', data: [], tension: 0.4, fill: true },
                        { label: 'Gas (PPM)', borderColor: '#10b981', borderDash: [5, 5], data: [], tension: 0.4, yAxisID: 'y1' },
                        { label: 'UV Index', borderColor: '#facc15', borderDash: [2, 2], data: [], tension: 0.4 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                        y1: { position: 'right', grid: { display: false }, ticks: { color: '#10b981' } }
                    }
                }
            });

            // Solar Chart
            const ctxSolar = document.getElementById('solarChart').getContext('2d');
            solarChart = new Chart(ctxSolar, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Power (W)', backgroundColor: '#22c55e', data: [] },
                        { label: 'Voltage (V)', backgroundColor: '#eab308', data: [] }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                    }
                }
            });
        }

        // --- Map Initialization ---
        function initMap() {
            // Initialize map centered on Ground Station initially
            map = L.map('map').setView([GS_LAT, GS_LON], 15);

            // Dark Mode Map Tiles (CartoDB Dark Matter)
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Ground Station Marker (Static)
            const gsIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#3b82f6; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 10px #3b82f6;'></div>",
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            groundMarker = L.marker([GS_LAT, GS_LON], { icon: gsIcon }).addTo(map)
                .bindPopup("Ground Station").openPopup();

            // Mobile Station Marker (Dynamic)
            const msIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#ef4444; width:16px; height:16px; border-radius:50%; border:2px solid white; box-shadow: 0 0 15px #ef4444; animation: pulse 2s infinite;'></div>",
                iconSize: [16, 16],
                iconAnchor: [8, 8]
            });
            mobileMarker = L.marker([GS_LAT, GS_LON], { icon: msIcon }).addTo(map);

            // Add CSS animation for marker pulse
            const style = document.createElement('style');
            style.innerHTML = `
                @keyframes pulse {
                    0% { transform: scale(1); opacity: 1; }
                    50% { transform: scale(1.5); opacity: 0.5; }
                    100% { transform: scale(1); opacity: 1; }
                }
            `;
            document.head.appendChild(style);
        }

        // --- Helper: Haversine Distance ---
        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Radius of earth in meters
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return Math.floor(R * c); // Distance in meters
        }

        function deg2rad(deg) {
            return deg * (Math.PI / 180);
        }

        // --- Improved Data Fetching & Parsing ---
        async function fetchData() {
            try {
                // Add cache busting to avoid browser caching
                const timestamp = new Date().getTime();
                const response = await fetch(`${SHEET_URL}&t=${timestamp}`);
                
                if (!response.ok) throw new Error("Network response was not ok");
                
                const text = await response.text();
                console.log("Raw CSV:", text); // Debug log
                
                // Parse CSV - handle different line endings and quotes
                const rows = text.split('\n')
                    .filter(row => row.trim().length > 0)
                    .map(row => {
                        // Handle quoted CSV values and proper CSV parsing
                        const matches = row.match(/(?:"[^"]*"|[^,])+/g);
                        return matches ? matches.map(cell => cell.replace(/^"|"$/g, '').trim()) : [];
                    });
                
                if (rows.length < 2) {
                    throw new Error("No data rows found");
                }

                const headers = rows[0].map(h => h.toLowerCase().trim());
                console.log("CSV Headers:", headers); // Debug log
                
                // Get the last data row (most recent entry)
                const lastRow = rows[rows.length - 1];
                console.log("Last row data:", lastRow); // Debug log

                // Map columns based on your actual CSV headers
                const getCol = (possibleNames, defaultIndex) => {
                    // Try to find by header name first
                    for (const name of possibleNames) {
                        const index = headers.findIndex(h => h.includes(name));
                        if (index !== -1 && lastRow[index] && !isNaN(parseFloat(lastRow[index]))) {
                            return parseFloat(lastRow[index]);
                        }
                    }
                    // Fallback to default index
                    return lastRow[defaultIndex] ? parseFloat(lastRow[defaultIndex]) : 0;
                };

                // Extract data based on your actual CSV structure
                const data = {
                    temp: getCol(['temperature', 'temp'], 3),
                    hum: getCol(['humidity', 'hum'], 4),
                    gas: getCol(['gas', 'ppm'], 5),
                    uv: getCol(['uv', 'uvindex'], 6),
                    solV: getCol(['solar_voltage', 'voltage', 'solar_v'], 7),
                    solI: getCol(['solar_current', 'current', 'solar_i'], 8),
                    lat: getCol(['latitude', 'lat'], 1) || GS_LAT,
                    lon: getCol(['longitude', 'lon', 'long'], 2) || GS_LON
                };

                // Calculate Power: Power (W) = Voltage (V) * Current (mA) / 1000
                data.solP = (data.solV * data.solI / 1000).toFixed(2);

                console.log("Parsed data:", data); // Debug log

                // Validate data
                if (isNaN(data.temp) || isNaN(data.hum)) {
                    throw new Error("Invalid data format");
                }

                updateUI(data);
                updateChartsWithNewData(data);
                
                // Update connection status
                document.getElementById('connection-status').innerHTML = 
                    `<span class="w-2 h-2 rounded-full bg-green-500"></span> Online`;
                    
            } catch (error) {
                console.error("Fetch error:", error);
                document.getElementById('connection-status').innerHTML = 
                    `<span class="w-2 h-2 rounded-full bg-red-500"></span> Offline (Demo Mode)`;
                useDummyData();
            }
        }

        // --- Improved Dummy Data Generator ---
        function useDummyData() {
            const time = Date.now() / 1000;
            
            // More realistic dummy data with gradual changes
            const data = {
                temp: 25 + Math.sin(time/50) * 8 + Math.random() * 2,
                hum: 50 + Math.cos(time/60) * 20 + Math.random() * 5,
                uv: Math.max(0, Math.sin(time/40) * 6 + 3 + Math.random()),
                gas: 100 + Math.sin(time/30) * 150 + Math.random() * 50,
                solV: 12 + Math.sin(time/20) * 2 + Math.random(),
                solI: 1500 + Math.cos(time/25) * 800 + Math.random() * 300, // in mA
                lat: GS_LAT + (Math.sin(time/30) * 0.005),
                lon: GS_LON + (Math.cos(time/30) * 0.005)
            };
            
            // Calculate power
            data.solP = (data.solV * data.solI / 1000).toFixed(2);
            
            // Round values appropriately
            data.temp = data.temp.toFixed(1);
            data.hum = data.hum.toFixed(1);
            data.uv = data.uv.toFixed(1);
            data.gas = Math.max(0, data.gas.toFixed(0));
            data.solV = data.solV.toFixed(1);
            data.solI = data.solI.toFixed(0); // Current in mA as whole number
            
            updateUI(data);
            updateChartsWithNewData(data);
        }

        // --- UI Updater ---
        function updateUI(data) {
            // Text Updates
            document.getElementById('val-temp').innerText = data.temp;
            document.getElementById('val-hum').innerText = data.hum;
            document.getElementById('val-uv').innerText = data.uv;
            document.getElementById('val-gas').innerText = data.gas;
            document.getElementById('val-sol-v').innerText = data.solV;
            document.getElementById('val-sol-i').innerText = data.solI;
            document.getElementById('val-sol-p').innerText = data.solP;
            document.getElementById('lbl-lat').innerText = data.lat.toFixed(6);
            document.getElementById('lbl-lon').innerText = data.lon.toFixed(6);
            document.getElementById('last-updated').innerText = "Last Updated: " + new Date().toLocaleTimeString();

            // Progress Bars
            document.getElementById('bar-temp').style.width = Math.min((data.temp / 50) * 100, 100) + '%';
            document.getElementById('bar-hum').style.width = Math.min(data.hum, 100) + '%';

            // Distance Calculation
            const dist = getDistanceFromLatLonInM(GS_LAT, GS_LON, data.lat, data.lon);
            document.getElementById('val-dist').innerText = dist;

            // Map Update
            if (mobileMarker) {
                const newLatLng = new L.LatLng(data.lat, data.lon);
                mobileMarker.setLatLng(newLatLng);
                
                // Only pan on first load or if significantly moved
                if (isFirstLoad) {
                    map.panTo(newLatLng);
                    isFirstLoad = false;
                }
                
                // Draw line
                if (polyline) map.removeLayer(polyline);
                polyline = L.polyline([[GS_LAT, GS_LON], [data.lat, data.lon]], {
                    color: 'rgba(59, 130, 246, 0.5)',
                    dashArray: '5, 10',
                    weight: 2
                }).addTo(map);
            }

            // Logic & Coloring
            // Temp
            const cardTemp = document.getElementById('card-temp');
            const barTemp = document.getElementById('bar-temp');
            if (data.temp > 35) {
                barTemp.classList.replace('bg-blue-500', 'bg-orange-500');
            } else {
                barTemp.classList.replace('bg-orange-500', 'bg-blue-500');
            }

            // UV
            const cardUV = document.getElementById('card-uv');
            const statusUV = document.getElementById('status-uv');
            cardUV.className = `stat-card glass rounded-xl p-6 relative overflow-hidden group transition-colors duration-500`; // Reset
            if (data.uv > 8) {
                cardUV.classList.add('border-red-500', 'bg-red-500/10');
                statusUV.innerText = "DANGER";
                statusUV.className = "text-xs mt-2 px-2 py-1 rounded bg-red-600 text-white inline-block w-fit";
            } else if (data.uv > 5) {
                cardUV.classList.add('border-yellow-500', 'bg-yellow-500/10');
                statusUV.innerText = "High";
                statusUV.className = "text-xs mt-2 px-2 py-1 rounded bg-yellow-600 text-black inline-block w-fit";
            } else {
                statusUV.innerText = "Normal";
                statusUV.className = "text-xs mt-2 px-2 py-1 rounded bg-slate-800 text-gray-300 inline-block w-fit";
            }

            // Gas
            const cardGas = document.getElementById('card-gas');
            const statusGas = document.getElementById('status-gas');
            cardGas.className = `stat-card glass rounded-xl p-6 relative overflow-hidden group transition-colors duration-500`;
            // Assuming threshold 200 for warning
            if (data.gas > 200) {
                cardGas.classList.add('border-red-500', 'bg-red-500/10');
                statusGas.innerText = "UNSAFE";
                statusGas.className = "text-xs mt-2 px-2 py-1 rounded bg-red-600 text-white inline-block w-fit animate-pulse";
            } else {
                statusGas.innerText = "Safe";
                statusGas.className = "text-xs mt-2 px-2 py-1 rounded bg-slate-800 text-gray-300 inline-block w-fit";
            }
        }

        function updateChartsWithNewData(data) {
            const timeLabel = new Date().toLocaleTimeString();
            
            // Env Chart
            if (envChart.data.labels.length > 15) {
                envChart.data.labels.shift();
                envChart.data.datasets.forEach((dataset) => dataset.data.shift());
            }
            envChart.data.labels.push(timeLabel);
            envChart.data.datasets[0].data.push(parseFloat(data.temp));
            envChart.data.datasets[1].data.push(parseFloat(data.hum));
            envChart.data.datasets[2].data.push(parseFloat(data.gas));
            envChart.data.datasets[3].data.push(parseFloat(data.uv));
            envChart.update('none'); // Use 'none' for better performance

            // Solar Chart
            if (solarChart.data.labels.length > 10) {
                solarChart.data.labels.shift();
                solarChart.data.datasets.forEach((dataset) => dataset.data.shift());
            }
            solarChart.data.labels.push(timeLabel);
            solarChart.data.datasets[0].data.push(parseFloat(data.solP));
            solarChart.data.datasets[1].data.push(parseFloat(data.solV));
            solarChart.update('none');
        }

        // --- Lifecycle ---
        window.onload = function() {
            initMap();
            initCharts();
            fetchData();
            setInterval(fetchData, REFRESH_RATE);
        };

    </script>
</body>
</html>
