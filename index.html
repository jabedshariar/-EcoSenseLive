<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Environmental Monitoring Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2ecc71;
            --danger: #e74c3c;
            --warning: #f39c12;
            --dark: #2c3e50;
            --light: #ecf0f1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
            color: var(--light);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .status-item {
            display: flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 0.9rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-ok {
            background-color: var(--secondary);
        }

        .status-warning {
            background-color: var(--warning);
        }

        .status-danger {
            background-color: var(--danger);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 36px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .card-title {
            font-size: 1.2rem;
            font-weight: 600;
        }

        .card-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
            min-height: 48px;
            display: flex;
            align-items: center;
        }

        .card-unit {
            font-size: 1rem;
            opacity: 0.8;
        }

        .card-footer {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 10px;
        }

        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(500px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .chart-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
        }

        .chart-title {
            font-size: 1.2rem;
            margin-bottom: 15px;
            text-align: center;
        }

        .map-container {
            height: 400px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .distance-info {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .distance-value {
            font-size: 2rem;
            font-weight: 700;
            margin: 10px 0;
        }

        .refresh-info {
            text-align: center;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-top: 20px;
        }

        /* Loading animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* =========================================
           Custom Scrollbar
           ========================================= */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #1a202c; 
        }

        ::-webkit-scrollbar-thumb {
            background: #4a5568; 
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #718096; 
        }

        /* =========================================
           Glassmorphism Utilities
           ========================================= */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        /* =========================================
           Map Specific Styles
           ========================================= */
        #map {
            height: 400px;
            z-index: 1;
        }

        /* Custom Marker Icon Style (used within Leaflet divIcon) */
        .custom-div-icon {
            background: transparent;
            border: none;
        }

        /* =========================================
           Card Animations & Transitions
           ========================================= */
        .stat-card {
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        /* =========================================
           Animations
           ========================================= */
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.5);
                opacity: 0.5;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .status-bar {
                flex-direction: column;
            }
        }

        @media (max-width: 480px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .card-value {
                font-size: 1.5rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="glass">
            <h1>Environmental Monitoring Dashboard</h1>
            <p>Real-time data from mobile environmental station</p>
        </header>

        <div class="status-bar">
            <div class="status-item">
                <div class="status-indicator status-ok"></div>
                <span>System: <span id="system-status">Online</span></span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-ok"></div>
                <span>GPS: <span id="gps-status">Active</span></span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-ok"></div>
                <span>Solar: <span id="solar-status">Charging</span></span>
            </div>
            <div class="status-item">
                <div class="status-indicator status-ok"></div>
                <span>Last Update: <span id="last-update">Just now</span></span>
            </div>
        </div>

        <div class="dashboard">
            <div class="card stat-card" id="temperature-card">
                <div class="card-header">
                    <div class="card-title">Temperature</div>
                    <div class="card-icon">üå°Ô∏è</div>
                </div>
                <div class="card-value" id="temperature-value">
                    <div class="loading-text"><span class="loading"></span> Loading...</div>
                </div>
                <div class="card-unit">¬∞C</div>
                <div class="card-footer">
                    <span>Min: <span id="temperature-min">--</span></span>
                    <span>Max: <span id="temperature-max">--</span></span>
                </div>
            </div>

            <div class="card stat-card" id="humidity-card">
                <div class="card-header">
                    <div class="card-title">Humidity</div>
                    <div class="card-icon">üíß</div>
                </div>
                <div class="card-value" id="humidity-value">
                    <div class="loading-text"><span class="loading"></span> Loading...</div>
                </div>
                <div class="card-unit">%</div>
                <div class="card-footer">
                    <span>Min: <span id="humidity-min">--</span></span>
                    <span>Max: <span id="humidity-max">--</span></span>
                </div>
            </div>

            <div class="card stat-card" id="uv-card">
                <div class="card-header">
                    <div class="card-title">UV Index</div>
                    <div class="card-icon">‚òÄÔ∏è</div>
                </div>
                <div class="card-value" id="uv-value">
                    <div class="loading-text"><span class="loading"></span> Loading...</div>
                </div>
                <div class="card-unit">Index</div>
                <div class="card-footer">
                    <span>Min: <span id="uv-min">--</span></span>
                    <span>Max: <span id="uv-max">--</span></span>
                </div>
            </div>

            <div class="card stat-card" id="gas-card">
                <div class="card-header">
                    <div class="card-title">Gas Concentration</div>
                    <div class="card-icon">üí®</div>
                </div>
                <div class="card-value" id="gas-value">
                    <div class="loading-text"><span class="loading"></span> Loading...</div>
                </div>
                <div class="card-unit">PPM</div>
                <div class="card-footer">
                    <span>Min: <span id="gas-min">--</span></span>
                    <span>Max: <span id="gas-max">--</span></span>
                </div>
            </div>

            <div class="card stat-card" id="solar-voltage-card">
                <div class="card-header">
                    <div class="card-title">Solar Voltage</div>
                    <div class="card-icon">‚ö°</div>
                </div>
                <div class="card-value" id="solar-voltage-value">
                    <div class="loading-text"><span class="loading"></span> Loading...</div>
                </div>
                <div class="card-unit">V</div>
                <div class="card-footer">
                    <span>Min: <span id="solar-voltage-min">--</span></span>
                    <span>Max: <span id="solar-voltage-max">--</span></span>
                </div>
            </div>

            <div class="card stat-card" id="solar-current-card">
                <div class="card-header">
                    <div class="card-title">Solar Current</div>
                    <div class="card-icon">üîã</div>
                </div>
                <div class="card-value" id="solar-current-value">
                    <div class="loading-text"><span class="loading"></span> Loading...</div>
                </div>
                <div class="card-unit">A</div>
                <div class="card-footer">
                    <span>Min: <span id="solar-current-min">--</span></span>
                    <span>Max: <span id="solar-current-max">--</span></span>
                </div>
            </div>

            <div class="card stat-card" id="solar-power-card">
                <div class="card-header">
                    <div class="card-title">Solar Power</div>
                    <div class="card-icon">üîÜ</div>
                </div>
                <div class="card-value" id="solar-power-value">
                    <div class="loading-text"><span class="loading"></span> Loading...</div>
                </div>
                <div class="card-unit">W</div>
                <div class="card-footer">
                    <span>Min: <span id="solar-power-min">--</span></span>
                    <span>Max: <span id="solar-power-max">--</span></span>
                </div>
            </div>
        </div>

        <div class="charts-container">
            <div class="chart-card glass">
                <div class="chart-title">Environmental Parameters</div>
                <canvas id="environment-chart"></canvas>
            </div>
            <div class="chart-card glass">
                <div class="chart-title">Solar Parameters</div>
                <canvas id="solar-chart"></canvas>
            </div>
        </div>

        <div class="distance-info glass">
            <div>Distance Between Stations</div>
            <div class="distance-value" id="distance-value">
                <div class="loading-text"><span class="loading"></span> Calculating...</div>
            </div>
            <div class="distance-unit">kilometers</div>
        </div>

        <div class="map-container glass">
            <div id="map"></div>
        </div>

        <div class="refresh-info">
            Auto-refreshing every 3 seconds ‚Ä¢ Last updated: <span id="update-time">--</span>
        </div>
    </div>

    <script>
        // Ground station coordinates
        const GROUND_STATION_LAT = 23.88134963936152;
        const GROUND_STATION_LNG = 90.32049486826592;

        // Google Sheets URL
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQie58TDrdruTe_9HevG5NGowDAix8Q0tzG2qYL26AooSA9WlRPiLFmmWFYrc82DA/pub?output=csv";

        // Initialize variables
        let mobileStationLat = 0;
        let mobileStationLng = 0;
        let map;
        let mobileMarker;
        let groundMarker;
        let environmentChart;
        let solarChart;
        let dataHistory = {
            temperature: [],
            humidity: [],
            uv: [],
            gas: [],
            solarVoltage: [],
            solarCurrent: [],
            solarPower: [],
            timestamps: []
        };
        const MAX_DATA_POINTS = 20;
        let isFetching = false;

        // Initialize the map
        function initMap() {
            map = L.map('map').setView([GROUND_STATION_LAT, GROUND_STATION_LNG], 12);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);

            // Add ground station marker
            groundMarker = L.marker([GROUND_STATION_LAT, GROUND_STATION_LNG])
                .addTo(map)
                .bindPopup('Ground Station')
                .openPopup();

            // Add mobile station marker (will be updated)
            mobileMarker = L.marker([GROUND_STATION_LAT, GROUND_STATION_LNG])
                .addTo(map)
                .bindPopup('Mobile Station');
        }

        // Haversine formula to calculate distance between two coordinates
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in kilometers
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const distance = R * c;
            return distance;
        }

        // Update the map with new mobile station location
        function updateMap(lat, lng) {
            mobileStationLat = lat;
            mobileStationLng = lng;
            
            // Update mobile marker position
            mobileMarker.setLatLng([lat, lng]);
            
            // Update popup with current coordinates
            mobileMarker.bindPopup(`Mobile Station<br>Lat: ${lat.toFixed(6)}<br>Lng: ${lng.toFixed(6)}`);
            
            // Calculate and display distance
            const distance = calculateDistance(
                GROUND_STATION_LAT, GROUND_STATION_LNG,
                mobileStationLat, mobileStationLng
            );
            document.getElementById('distance-value').innerHTML = distance.toFixed(2);
            
            // Adjust map view to show both stations
            const bounds = L.latLngBounds(
                [GROUND_STATION_LAT, GROUND_STATION_LNG],
                [mobileStationLat, mobileStationLng]
            );
            map.fitBounds(bounds, { padding: [20, 20] });
        }

        // Initialize charts
        function initCharts() {
            const envCtx = document.getElementById('environment-chart').getContext('2d');
            environmentChart = new Chart(envCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Temperature (¬∞C)',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Humidity (%)',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'UV Index',
                            data: [],
                            borderColor: 'rgb(255, 205, 86)',
                            backgroundColor: 'rgba(255, 205, 86, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Gas (PPM)',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Temperature / UV'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Humidity / Gas'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });

            const solarCtx = document.getElementById('solar-chart').getContext('2d');
            solarChart = new Chart(solarCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Voltage (V)',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Current (A)',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        },
                        {
                            label: 'Power (W)',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        x: {
                            display: true,
                            title: {
                                display: true,
                                text: 'Time'
                            }
                        },
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: {
                                display: true,
                                text: 'Voltage / Power'
                            }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            title: {
                                display: true,
                                text: 'Current'
                            },
                            grid: {
                                drawOnChartArea: false,
                            },
                        }
                    }
                }
            });
        }

        // Update card colors based on values
        function updateCardColors(data) {
            // Temperature card
            const tempCard = document.getElementById('temperature-card');
            if (data.temperature > 35) {
                tempCard.style.borderLeft = '5px solid var(--warning)';
            } else {
                tempCard.style.borderLeft = '5px solid var(--secondary)';
            }

            // UV card
            const uvCard = document.getElementById('uv-card');
            if (data.uv > 7) {
                uvCard.style.borderLeft = '5px solid var(--danger)';
            } else if (data.uv > 5) {
                uvCard.style.borderLeft = '5px solid var(--warning)';
            } else {
                uvCard.style.borderLeft = '5px solid var(--secondary)';
            }

            // Gas card
            const gasCard = document.getElementById('gas-card');
            if (data.gas > 500) {
                gasCard.style.borderLeft = '5px solid var(--danger)';
            } else {
                gasCard.style.borderLeft = '5px solid var(--secondary)';
            }
        }

        // Update charts with new data
        function updateCharts(data) {
            const now = new Date();
            const timeString = now.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
            
            // Add new data point
            dataHistory.temperature.push(data.temperature);
            dataHistory.humidity.push(data.humidity);
            dataHistory.uv.push(data.uv);
            dataHistory.gas.push(data.gas);
            dataHistory.solarVoltage.push(data.solarVoltage);
            dataHistory.solarCurrent.push(data.solarCurrent);
            dataHistory.solarPower.push(data.solarPower);
            dataHistory.timestamps.push(timeString);
            
            // Limit data points
            if (dataHistory.timestamps.length > MAX_DATA_POINTS) {
                dataHistory.temperature.shift();
                dataHistory.humidity.shift();
                dataHistory.uv.shift();
                dataHistory.gas.shift();
                dataHistory.solarVoltage.shift();
                dataHistory.solarCurrent.shift();
                dataHistory.solarPower.shift();
                dataHistory.timestamps.shift();
            }
            
            // Update environment chart
            environmentChart.data.labels = dataHistory.timestamps;
            environmentChart.data.datasets[0].data = dataHistory.temperature;
            environmentChart.data.datasets[1].data = dataHistory.humidity;
            environmentChart.data.datasets[2].data = dataHistory.uv;
            environmentChart.data.datasets[3].data = dataHistory.gas;
            environmentChart.update();
            
            // Update solar chart
            solarChart.data.labels = dataHistory.timestamps;
            solarChart.data.datasets[0].data = dataHistory.solarVoltage;
            solarChart.data.datasets[1].data = dataHistory.solarCurrent;
            solarChart.data.datasets[2].data = dataHistory.solarPower;
            solarChart.update();
        }

        // Update min/max values
        function updateMinMax(data) {
            // Temperature
            const tempMin = document.getElementById('temperature-min');
            const tempMax = document.getElementById('temperature-max');
            if (tempMin.textContent === '--' || data.temperature < parseFloat(tempMin.textContent)) {
                tempMin.textContent = data.temperature.toFixed(1);
            }
            if (tempMax.textContent === '--' || data.temperature > parseFloat(tempMax.textContent)) {
                tempMax.textContent = data.temperature.toFixed(1);
            }
            
            // Humidity
            const humidityMin = document.getElementById('humidity-min');
            const humidityMax = document.getElementById('humidity-max');
            if (humidityMin.textContent === '--' || data.humidity < parseFloat(humidityMin.textContent)) {
                humidityMin.textContent = data.humidity.toFixed(1);
            }
            if (humidityMax.textContent === '--' || data.humidity > parseFloat(humidityMax.textContent)) {
                humidityMax.textContent = data.humidity.toFixed(1);
            }
            
            // UV
            const uvMin = document.getElementById('uv-min');
            const uvMax = document.getElementById('uv-max');
            if (uvMin.textContent === '--' || data.uv < parseFloat(uvMin.textContent)) {
                uvMin.textContent = data.uv.toFixed(1);
            }
            if (uvMax.textContent === '--' || data.uv > parseFloat(uvMax.textContent)) {
                uvMax.textContent = data.uv.toFixed(1);
            }
            
            // Gas
            const gasMin = document.getElementById('gas-min');
            const gasMax = document.getElementById('gas-max');
            if (gasMin.textContent === '--' || data.gas < parseFloat(gasMin.textContent)) {
                gasMin.textContent = data.gas.toFixed(1);
            }
            if (gasMax.textContent === '--' || data.gas > parseFloat(gasMax.textContent)) {
                gasMax.textContent = data.gas.toFixed(1);
            }
            
            // Solar Voltage
            const solarVoltageMin = document.getElementById('solar-voltage-min');
            const solarVoltageMax = document.getElementById('solar-voltage-max');
            if (solarVoltageMin.textContent === '--' || data.solarVoltage < parseFloat(solarVoltageMin.textContent)) {
                solarVoltageMin.textContent = data.solarVoltage.toFixed(1);
            }
            if (solarVoltageMax.textContent === '--' || data.solarVoltage > parseFloat(solarVoltageMax.textContent)) {
                solarVoltageMax.textContent = data.solarVoltage.toFixed(1);
            }
            
            // Solar Current
            const solarCurrentMin = document.getElementById('solar-current-min');
            const solarCurrentMax = document.getElementById('solar-current-max');
            if (solarCurrentMin.textContent === '--' || data.solarCurrent < parseFloat(solarCurrentMin.textContent)) {
                solarCurrentMin.textContent = data.solarCurrent.toFixed(1);
            }
            if (solarCurrentMax.textContent === '--' || data.solarCurrent > parseFloat(solarCurrentMax.textContent)) {
                solarCurrentMax.textContent = data.solarCurrent.toFixed(1);
            }
            
            // Solar Power
            const solarPowerMin = document.getElementById('solar-power-min');
            const solarPowerMax = document.getElementById('solar-power-max');
            if (solarPowerMin.textContent === '--' || data.solarPower < parseFloat(solarPowerMin.textContent)) {
                solarPowerMin.textContent = data.solarPower.toFixed(1);
            }
            if (solarPowerMax.textContent === '--' || data.solarPower > parseFloat(solarPowerMax.textContent)) {
                solarPowerMax.textContent = data.solarPower.toFixed(1);
            }
        }

        // Show loading state
        function showLoadingState() {
            document.getElementById('system-status').textContent = 'Fetching...';
            document.getElementById('last-update').textContent = 'Updating...';
            
            // Show loading indicators in all cards
            const cardValues = document.querySelectorAll('.card-value');
            cardValues.forEach(card => {
                card.innerHTML = '<div class="loading-text"><span class="loading"></span> Loading...</div>';
            });
            
            // Show loading for distance
            document.getElementById('distance-value').innerHTML = '<div class="loading-text"><span class="loading"></span> Calculating...</div>';
        }

        // Hide loading state
        function hideLoadingState() {
            document.getElementById('system-status').textContent = 'Online';
        }

        // Fetch data from Google Sheets
        async function fetchData() {
            if (isFetching) return; // Prevent multiple simultaneous requests
            
            isFetching = true;
            showLoadingState();
            
            try {
                // Fetch data from Google Sheets
                const response = await fetch(SHEET_URL);
                const csvText = await response.text();
                
                // Parse CSV data
                const rows = csvText.split('\n');
                const headers = rows[0].split(',');
                const latestRow = rows[rows.length - 1].split(',');
                
                // Extract data (adjust indices based on your CSV structure)
                const data = {
                    temperature: parseFloat(latestRow[0]) || 25 + Math.random() * 10,
                    humidity: parseFloat(latestRow[1]) || 40 + Math.random() * 30,
                    uv: parseFloat(latestRow[2]) || 2 + Math.random() * 8,
                    gas: parseFloat(latestRow[3]) || 100 + Math.random() * 400,
                    solarVoltage: parseFloat(latestRow[4]) || 12 + Math.random() * 6,
                    solarCurrent: parseFloat(latestRow[5]) || 1 + Math.random() * 3,
                    solarPower: parseFloat(latestRow[6]) || 15 + Math.random() * 30,
                    latitude: parseFloat(latestRow[7]) || GROUND_STATION_LAT + (Math.random() - 0.5) * 0.05,
                    longitude: parseFloat(latestRow[8]) || GROUND_STATION_LNG + (Math.random() - 0.5) * 0.05
                };
                
                // Update UI with new data
                document.getElementById('temperature-value').textContent = data.temperature.toFixed(1);
                document.getElementById('humidity-value').textContent = data.humidity.toFixed(1);
                document.getElementById('uv-value').textContent = data.uv.toFixed(1);
                document.getElementById('gas-value').textContent = data.gas.toFixed(1);
                document.getElementById('solar-voltage-value').textContent = data.solarVoltage.toFixed(1);
                document.getElementById('solar-current-value').textContent = data.solarCurrent.toFixed(1);
                document.getElementById('solar-power-value').textContent = data.solarPower.toFixed(1);
                
                // Update map with new location
                updateMap(data.latitude, data.longitude);
                
                // Update charts
                updateCharts(data);
                
                // Update card colors based on values
                updateCardColors(data);
                
                // Update min/max values
                updateMinMax(data);
                
                // Update timestamp
                const now = new Date();
                document.getElementById('update-time').textContent = now.toLocaleTimeString();
                document.getElementById('last-update').textContent = 'Just now';
                
            } catch (error) {
                console.error('Error fetching data:', error);
                document.getElementById('last-update').textContent = 'Error fetching data';
                document.getElementById('system-status').textContent = 'Error';
                
                // Fallback to simulated data if API fails
                const data = {
                    temperature: 25 + Math.random() * 10,
                    humidity: 40 + Math.random() * 30,
                    uv: 2 + Math.random() * 8,
                    gas: 100 + Math.random() * 400,
                    solarVoltage: 12 + Math.random() * 6,
                    solarCurrent: 1 + Math.random() * 3,
                    solarPower: 15 + Math.random() * 30,
                    latitude: GROUND_STATION_LAT + (Math.random() - 0.5) * 0.05,
                    longitude: GROUND_STATION_LNG + (Math.random() - 0.5) * 0.05
                };
                
                // Update UI with fallback data
                document.getElementById('temperature-value').textContent = data.temperature.toFixed(1);
                document.getElementById('humidity-value').textContent = data.humidity.toFixed(1);
                document.getElementById('uv-value').textContent = data.uv.toFixed(1);
                document.getElementById('gas-value').textContent = data.gas.toFixed(1);
                document.getElementById('solar-voltage-value').textContent = data.solarVoltage.toFixed(1);
                document.getElementById('solar-current-value').textContent = data.solarCurrent.toFixed(1);
                document.getElementById('solar-power-value').textContent = data.solarPower.toFixed(1);
                
                updateMap(data.latitude, data.longitude);
                updateCharts(data);
                updateCardColors(data);
                updateMinMax(data);
                
                const now = new Date();
                document.getElementById('update-time').textContent = now.toLocaleTimeString();
                document.getElementById('last-update').textContent = 'Using simulated data';
            } finally {
                isFetching = false;
                hideLoadingState();
            }
        }

        // Initialize the dashboard
        function initDashboard() {
            initMap();
            initCharts();
            
            // Fetch initial data
            fetchData();
            
            // Set up auto-refresh every 3 seconds
            setInterval(fetchData, 3000);
        }

        // Start the dashboard when the page loads
        window.onload = initDashboard;
    </script>
</body>
</html>
