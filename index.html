<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoSense Live Monitor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        /* Animation Keyframes */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }

        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes bg-pan {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Utility Classes */
        .animate-entry {
            animation: fadeInUp 0.8s cubic-bezier(0.16, 1, 0.3, 1) forwards;
            opacity: 0; /* Hidden initially */
        }
        
        .animate-float {
            animation: float 6s ease-in-out infinite;
        }

        .delay-100 { animation-delay: 100ms; }
        .delay-200 { animation-delay: 200ms; }
        .delay-300 { animation-delay: 300ms; }
        .delay-400 { animation-delay: 400ms; }

        /* Glassmorphism Pro */
        .glass {
            background: rgba(30, 41, 59, 0.4); /* Darker, richer tint */
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }

        /* Hover Glow Effects */
        .glass:hover {
            border-color: rgba(255, 255, 255, 0.15);
            transform: translateY(-5px) scale(1.01);
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.3);
        }

        .card-temp:hover { box-shadow: 0 0 25px rgba(59, 130, 246, 0.15); border-color: rgba(59, 130, 246, 0.3); }
        .card-hum:hover { box-shadow: 0 0 25px rgba(34, 211, 238, 0.15); border-color: rgba(34, 211, 238, 0.3); }
        .card-uv:hover { box-shadow: 0 0 25px rgba(250, 204, 21, 0.15); border-color: rgba(250, 204, 21, 0.3); }
        .card-gas:hover { box-shadow: 0 0 25px rgba(16, 185, 129, 0.15); border-color: rgba(16, 185, 129, 0.3); }

        /* Map & Chart Containers */
        #map { z-index: 1; }
        
        /* Map Marker Pulse */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        @keyframes pulse-dot {
            0% { transform: scale(0.8); }
            50% { transform: scale(1); }
            100% { transform: scale(0.8); }
        }

        /* Background Mesh */
        .bg-mesh {
            background: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-size: 200% 200%;
            animation: bg-pan 30s ease infinite;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans min-h-screen selection:bg-cyan-500 selection:text-white flex flex-col overflow-x-hidden bg-mesh">

    <!-- Navbar -->
    <nav class="glass sticky top-0 z-50 border-b border-white/5 animate-entry">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-20">
                <div class="flex items-center gap-4">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-cyan-400 flex items-center justify-center shadow-lg shadow-blue-500/30">
                        <i class="fa-solid fa-satellite-dish text-white text-lg"></i>
                    </div>
                    <div class="flex flex-col">
                        <span class="font-bold text-2xl tracking-tight leading-none">EcoSense<span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-cyan-300">Live</span></span>
                        <span class="text-[10px] text-slate-400 uppercase tracking-[0.2em]">Monitoring System</span>
                    </div>
                </div>
                <div class="flex flex-col items-end gap-1">
                    <!-- Status Indicator will be updated by JS -->
                    <span id="connection-status" class="flex items-center gap-2 text-xs font-semibold px-3 py-1 rounded-full bg-slate-800 text-slate-400 border border-slate-700">
                        <span class="w-1.5 h-1.5 rounded-full bg-slate-500"></span> Connecting...
                    </span>
                    <span id="last-updated" class="text-[10px] text-slate-500 font-mono">Initializing...</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow space-y-8">
        
        <!-- Status Overview Cards (Row 1) -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 animate-entry delay-100">
            
            <!-- Temperature -->
            <div id="card-temp" class="glass card-temp rounded-2xl p-6 relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-blue-500/20 rounded-full blur-2xl group-hover:bg-blue-500/30 transition-all duration-500"></div>
                <div class="absolute right-6 top-6 text-slate-600/50 group-hover:text-blue-400/50 transition-colors duration-300 animate-float">
                    <i class="fa-solid fa-temperature-three-quarters text-5xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-blue-400 text-xs font-bold uppercase tracking-wider">Temperature</span>
                        <span id="status-temp" class="text-[10px] px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">Syncing</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span id="val-temp" class="text-4xl font-black tracking-tight text-white">--</span>
                        <span class="text-lg text-slate-400 font-medium">Â°C</span>
                    </div>
                    <div class="mt-4 h-1.5 w-full bg-slate-800/80 rounded-full overflow-hidden backdrop-blur-sm">
                        <div id="bar-temp" class="h-full bg-gradient-to-r from-blue-600 to-blue-400 w-0 transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                    </div>
                </div>
            </div>

            <!-- Humidity -->
            <div id="card-hum" class="glass card-hum rounded-2xl p-6 relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-cyan-500/20 rounded-full blur-2xl group-hover:bg-cyan-500/30 transition-all duration-500"></div>
                <div class="absolute right-6 top-6 text-slate-600/50 group-hover:text-cyan-400/50 transition-colors duration-300 animate-float delay-100">
                    <i class="fa-solid fa-droplet text-5xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-cyan-400 text-xs font-bold uppercase tracking-wider">Humidity</span>
                        <span id="status-hum" class="text-[10px] px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">Syncing</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span id="val-hum" class="text-4xl font-black tracking-tight text-white">--</span>
                        <span class="text-lg text-slate-400 font-medium">%</span>
                    </div>
                    <div class="mt-4 h-1.5 w-full bg-slate-800/80 rounded-full overflow-hidden backdrop-blur-sm">
                        <div id="bar-hum" class="h-full bg-gradient-to-r from-cyan-600 to-cyan-400 w-0 transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(34,211,238,0.5)]"></div>
                    </div>
                </div>
            </div>

            <!-- UV Index -->
            <div id="card-uv" class="glass card-uv rounded-2xl p-6 relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-yellow-500/20 rounded-full blur-2xl group-hover:bg-yellow-500/30 transition-all duration-500"></div>
                <div class="absolute right-6 top-6 text-slate-600/50 group-hover:text-yellow-400/50 transition-colors duration-300 animate-float delay-200">
                    <i class="fa-regular fa-sun text-5xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-yellow-400 text-xs font-bold uppercase tracking-wider">UV Index</span>
                        <span id="status-uv" class="text-[10px] px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">Syncing</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span id="val-uv" class="text-4xl font-black tracking-tight text-white">--</span>
                        <span class="text-lg text-slate-400 font-medium">Idx</span>
                    </div>
                    <!-- Mini visual indicator for UV -->
                    <div class="mt-4 flex gap-1 h-1.5">
                        <div class="flex-1 rounded-l-full bg-green-500/20 overflow-hidden"><div id="uv-seg-1" class="h-full w-full bg-green-500 opacity-0 transition-opacity"></div></div>
                        <div class="flex-1 bg-yellow-500/20 overflow-hidden"><div id="uv-seg-2" class="h-full w-full bg-yellow-500 opacity-0 transition-opacity"></div></div>
                        <div class="flex-1 bg-orange-500/20 overflow-hidden"><div id="uv-seg-3" class="h-full w-full bg-orange-500 opacity-0 transition-opacity"></div></div>
                        <div class="flex-1 rounded-r-full bg-red-500/20 overflow-hidden"><div id="uv-seg-4" class="h-full w-full bg-red-500 opacity-0 transition-opacity"></div></div>
                    </div>
                </div>
            </div>

            <!-- Gas PPM -->
            <div id="card-gas" class="glass card-gas rounded-2xl p-6 relative overflow-hidden group">
                <div class="absolute -right-4 -top-4 w-24 h-24 bg-green-500/20 rounded-full blur-2xl group-hover:bg-green-500/30 transition-all duration-500"></div>
                <div class="absolute right-6 top-6 text-slate-600/50 group-hover:text-green-400/50 transition-colors duration-300 animate-float delay-300">
                    <i class="fa-solid fa-wind text-5xl"></i>
                </div>
                <div class="relative z-10">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-green-400 text-xs font-bold uppercase tracking-wider">Air Quality</span>
                        <span id="status-gas" class="text-[10px] px-1.5 py-0.5 rounded bg-slate-800 text-slate-400">Syncing</span>
                    </div>
                    <div class="flex items-baseline gap-1">
                        <span id="val-gas" class="text-4xl font-black tracking-tight text-white">--</span>
                        <span class="text-lg text-slate-400 font-medium">PPM</span>
                    </div>
                    <div class="mt-4 h-1.5 w-full bg-slate-800/80 rounded-full overflow-hidden backdrop-blur-sm">
                        <div id="bar-gas" class="h-full bg-gradient-to-r from-green-600 to-green-400 w-0 transition-all duration-1000 ease-out shadow-[0_0_10px_rgba(16,185,129,0.5)]"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analytics & Distance (Row 2) -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 animate-entry delay-200">
            
            <!-- Environmental Analytics Chart (Spans 3 Columns) -->
            <div class="lg:col-span-3 glass rounded-2xl p-6 sm:p-8 flex flex-col min-h-[400px]">
                <div class="flex items-center justify-between mb-6">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i class="fa-solid fa-chart-line text-purple-400"></i> Environmental Trends
                    </h3>
                    <div class="flex flex-wrap justify-end gap-2 text-[10px] font-bold uppercase">
                        <span class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-red-500/10 text-red-400 border border-red-500/20"><span class="w-1.5 h-1.5 rounded-full bg-red-400"></span> Temp</span>
                        <span class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-blue-500/10 text-blue-400 border border-blue-500/20"><span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span> Hum</span>
                        <span class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-green-500/10 text-green-400 border border-green-500/20"><span class="w-1.5 h-1.5 rounded-full bg-green-400"></span> Gas</span>
                        <span class="flex items-center gap-1.5 px-2 py-1 rounded-md bg-yellow-500/10 text-yellow-400 border border-yellow-500/20"><span class="w-1.5 h-1.5 rounded-full bg-yellow-400"></span> UV</span>
                    </div>
                </div>
                <div class="flex-grow w-full h-full relative">
                    <canvas id="envChart"></canvas>
                </div>
            </div>

            <!-- Distance Card (Spans 1 Column) -->
            <div class="glass rounded-2xl p-6 flex flex-col justify-between relative overflow-hidden group min-h-[400px]">
                <div class="absolute inset-0 bg-gradient-to-b from-blue-500/5 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-500"></div>
                <div class="absolute -right-8 -bottom-8 w-40 h-40 bg-blue-500/10 rounded-full blur-3xl animate-pulse-soft"></div>
                
                <div class="relative z-10">
                    <h3 class="text-lg font-bold mb-1 flex items-center gap-2">
                        <i class="fa-solid fa-ruler-horizontal text-blue-400"></i> Range
                    </h3>
                    <p class="text-slate-500 text-xs">Distance to Base</p>
                </div>
                
                <div class="text-center py-6 relative z-10 my-auto">
                    <div class="flex items-center justify-center gap-2">
                         <span id="val-dist" class="text-6xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-br from-white to-slate-400 drop-shadow-sm">--</span>
                    </div>
                    <span class="text-sm text-blue-400 font-medium uppercase tracking-widest mt-1 block">Meters</span>
                </div>
                
                <div class="mt-2 text-[10px] text-center text-slate-500 font-mono bg-slate-950/30 py-4 rounded-lg border border-white/5 relative z-10">
                    <div class="mb-1">LAT: <span id="lbl-lat" class="text-slate-300">--</span></div>
                    <div>LON: <span id="lbl-lon" class="text-slate-300">--</span></div>
                </div>
            </div>
        </div>

        <!-- Map (Row 3 - Full Width) -->
        <div class="animate-entry delay-300 min-h-[500px]">
            <div class="glass rounded-2xl p-1 overflow-hidden flex flex-col h-full">
                <div class="p-4 bg-slate-900/40 flex justify-between items-center backdrop-blur-md border-b border-white/5">
                    <h3 class="text-lg font-bold flex items-center gap-2">
                        <i class="fa-solid fa-location-dot text-red-500"></i> Live GPS Tracking
                    </h3>
                    <span class="text-[10px] font-bold bg-red-600 px-2 py-0.5 rounded text-white shadow-[0_0_10px_rgba(220,38,38,0.5)] animate-pulse">LIVE</span>
                </div>
                <!-- Map Container with Explicit Height -->
                <div id="map" class="w-full h-[500px] rounded-b-xl bg-slate-900 relative grayscale-[0.5] hover:grayscale-0 transition-all duration-500"></div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-white/5 mt-12 py-8 bg-slate-950/50 backdrop-blur-lg">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <p class="text-slate-500 text-sm mb-2">EcoSense Dashboard &copy; 2023. Real-time Environmental Monitoring System.</p>
            <p class="text-sm text-slate-400">
                Designed & Developed by 
                <a href="https://jabedshariar.vercel.app" target="_blank" class="text-cyan-400 hover:text-cyan-300 font-medium hover:underline decoration-cyan-400/30 underline-offset-4 transition-all">Jabed Shariar</a>
            </p>
        </div>
    </footer>

    <script>
        // --- Configuration ---
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQqEZLEedPEq1MeRXgJ7LKX89wdVQ5Ll7HuSot9rBCrZz61hrFt56HW2mRqHiMdqC4W15EY6bom42Ih/pub?output=csv";
        
        const GS_LAT = 23.88134963936152;
        const GS_LON = 90.32049486826592;

        let map, mobileMarker, groundMarker, polyline;
        let envChart;
        let isFirstLoad = true;
        let lastDataTimestamp = null; // Store valid timestamp for status check
        let isFetching = false; // Prevent overlapping fetch requests

        // --- Chart Initialization with Modern Config ---
        Chart.defaults.color = '#64748b';
        Chart.defaults.font.family = 'ui-sans-serif, system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial';

        function initCharts() {
            // Env Chart
            const ctxEnv = document.getElementById('envChart').getContext('2d');
            const gradientTemp = ctxEnv.createLinearGradient(0, 0, 0, 400);
            gradientTemp.addColorStop(0, 'rgba(239, 68, 68, 0.2)');
            gradientTemp.addColorStop(1, 'rgba(239, 68, 68, 0)');

            envChart = new Chart(ctxEnv, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Temp', borderColor: '#ef4444', backgroundColor: gradientTemp, data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: true, yAxisID: 'y' },
                        { label: 'Hum', borderColor: '#3b82f6', backgroundColor: 'transparent', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, borderDash: [5,5], yAxisID: 'y' },
                        { label: 'UV', borderColor: '#eab308', backgroundColor: 'transparent', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, yAxisID: 'y' },
                        { label: 'Gas', borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.05)', data: [], tension: 0.4, borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: true, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 10, cornerRadius: 8, displayColors: true } },
                    scales: {
                        x: { display: false },
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(255,255,255,0.03)' }, 
                            border: { display: false }
                        },
                        y1: { 
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { display: false }, 
                            border: { display: false },
                            ticks: { color: '#10b981', font: {size: 10} }
                        }
                    }
                }
            });
        }

        // --- Map Initialization ---
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([GS_LAT, GS_LON], 15);
            L.control.zoom({ position: 'bottomright' }).addTo(map);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            const gsIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#3b82f6; width:14px; height:14px; border-radius:50%; border:2px solid white; box-shadow: 0 0 15px #3b82f6;'></div>",
                iconSize: [14, 14],
                iconAnchor: [7, 7]
            });
            groundMarker = L.marker([GS_LAT, GS_LON], { icon: gsIcon }).addTo(map).bindPopup("Ground Station");

            const msIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="position: relative;">
                         <div style="position: absolute; top: -10px; left: -10px; width: 40px; height: 40px; background: rgba(239, 68, 68, 0.3); border-radius: 50%; animation: pulse-ring 2s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;"></div>
                         <div style="position: absolute; top: 5px; left: 5px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; border: 2px solid white; box-shadow: 0 0 10px #ef4444;"></div>
                       </div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            mobileMarker = L.marker([GS_LAT, GS_LON], { icon: msIcon }).addTo(map);
        }

        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            const R = 6371000; 
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return Math.floor(R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a))); 
        }

        async function fetchData() {
            // Prevent multiple requests stacking up if network is slow
            if (isFetching) return;
            isFetching = true;

            try {
                const response = await fetch(SHEET_URL + "&cache_buster=" + Date.now(), { cache: 'reload' });
                if (!response.ok) throw new Error("Network response was not ok");
                const text = await response.text();
                
                const rows = text.split('\n').map(row => row.split(','));
                const dataRows = rows.filter(r => r.join('').trim().length > 0);
                
                if (dataRows.length < 2) return;

                const headers = dataRows[0].map(h => h.trim()); 
                const timestampIdx = headers.indexOf('Timestamp');

                const allData = dataRows.slice(1).map(row => {
                    if(row.length < headers.length) return null;
                    const cleanTime = row[timestampIdx] ? row[timestampIdx].replace(/"/g, '').trim() : '';
                    const time = new Date(cleanTime);
                    return { rowRaw: row, timeObj: time, valid: !isNaN(time.getTime()) };
                }).filter(item => item && item.valid);

                allData.sort((a, b) => b.timeObj - a.timeObj);
                if (allData.length === 0) return;

                const latestEntry = allData[0];
                const lastRow = latestEntry.rowRaw;
                
                // Set global timestamp for status tracking
                lastDataTimestamp = latestEntry.timeObj;
                updateConnectionStatus(); // Update immediately

                const getVal = (headerName) => {
                    const idx = headers.indexOf(headerName);
                    if (idx === -1) return 0; 
                    let val = lastRow[idx];
                    if (typeof val === 'string') val = val.replace(/"/g, '').trim();
                    return val; 
                };

                const dataObj = {
                    timestampStr: getVal('Timestamp'),
                    lat: parseFloat(getVal('Latitude')) || GS_LAT,
                    lon: parseFloat(getVal('Longitude')) || GS_LON,
                    temp: parseFloat(getVal('Temperature_C')) || 0,
                    hum: parseFloat(getVal('Humidity_%')) || 0,
                    gas: parseFloat(getVal('Gas_PPM')) || 0,
                    uv: parseFloat(getVal('UV_Index')) || 0
                };

                updateUI(dataObj);
                
                const history = allData.slice(0, 20).reverse().map(item => {
                    const row = item.rowRaw;
                    const getRowVal = (name) => {
                         const i = headers.indexOf(name);
                         return i !== -1 ? parseFloat(row[i]) : 0;
                    };
                    return {
                        time: row[timestampIdx],
                        temp: getRowVal('Temperature_C'),
                        hum: getRowVal('Humidity_%'),
                        gas: getRowVal('Gas_PPM'),
                        uv: getRowVal('UV_Index')
                    };
                });
                updateChartsHistory(history);

            } catch (error) {
                console.error("Fetch error:", error);
                document.getElementById('connection-status').innerHTML = 
                    `<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Error`;
            } finally {
                isFetching = false;
            }
        }

        // --- Connection Status Logic ---
        function updateConnectionStatus() {
            if (!lastDataTimestamp) return;

            const now = new Date();
            const diffMs = now - lastDataTimestamp;
            const diffSec = Math.floor(diffMs / 1000);
            const statusEl = document.getElementById('connection-status');
            
            let statusHTML = '';
            
            // Updated threshold to 120 seconds (2 minutes) as requested
            if (diffSec <= 120) {
                 // Connected
                 statusHTML = `<span class="w-1.5 h-1.5 rounded-full bg-green-400 animate-pulse"></span> Connected`;
                 statusEl.className = "flex items-center gap-2 text-xs font-semibold px-3 py-1 rounded-full bg-green-500/10 text-green-400 border border-green-500/20";
            } else if (diffSec <= 3600) { // 60 minutes
                 // Last connected X ago
                 let timeText = diffSec < 60 ? `${diffSec} sec ago` : `${Math.floor(diffSec/60)} min ago`;
                 statusHTML = `<span class="w-1.5 h-1.5 rounded-full bg-yellow-400"></span> Last seen ${timeText}`;
                 statusEl.className = "flex items-center gap-2 text-xs font-semibold px-3 py-1 rounded-full bg-yellow-500/10 text-yellow-400 border border-yellow-500/20";
            } else {
                 // Offline
                 statusHTML = `<span class="w-1.5 h-1.5 rounded-full bg-red-500"></span> Offline`;
                 statusEl.className = "flex items-center gap-2 text-xs font-semibold px-3 py-1 rounded-full bg-red-500/10 text-red-400 border border-red-500/20";
            }
            
            statusEl.innerHTML = statusHTML;
        }

        function updateUI(data) {
            document.getElementById('val-temp').innerText = data.temp;
            document.getElementById('val-hum').innerText = data.hum;
            document.getElementById('val-uv').innerText = data.uv;
            document.getElementById('val-gas').innerText = data.gas;
            document.getElementById('lbl-lat').innerText = data.lat.toFixed(6);
            document.getElementById('lbl-lon').innerText = data.lon.toFixed(6);
            
            const timeStr = data.timestampStr || "Unknown";
            const dateObj = new Date(timeStr);
            const formattedTime = !isNaN(dateObj) ? dateObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}) : timeStr;
            document.getElementById('last-updated').innerText = "UPDATED: " + formattedTime;

            // Bar Widths
            document.getElementById('bar-temp').style.width = Math.min((data.temp / 50) * 100, 100) + '%';
            document.getElementById('bar-hum').style.width = Math.min(data.hum, 100) + '%';
            document.getElementById('bar-gas').style.width = Math.min((data.gas / 500) * 100, 100) + '%';

            // UV Visualizer
            const uvSegs = ['uv-seg-1', 'uv-seg-2', 'uv-seg-3', 'uv-seg-4'];
            uvSegs.forEach(id => document.getElementById(id).style.opacity = '0');
            if (data.uv > 0) document.getElementById('uv-seg-1').style.opacity = '1';
            if (data.uv > 3) document.getElementById('uv-seg-2').style.opacity = '1';
            if (data.uv > 6) document.getElementById('uv-seg-3').style.opacity = '1';
            if (data.uv > 9) document.getElementById('uv-seg-4').style.opacity = '1';

            // Distance
            document.getElementById('val-dist').innerText = getDistanceFromLatLonInM(GS_LAT, GS_LON, data.lat, data.lon);

            // Map
            if (mobileMarker) {
                const newLatLng = new L.LatLng(data.lat, data.lon);
                mobileMarker.setLatLng(newLatLng);
                if (isFirstLoad && data.lat !== 0) { map.panTo(newLatLng); isFirstLoad = false; }
                if (polyline) map.removeLayer(polyline);
                polyline = L.polyline([[GS_LAT, GS_LON], [data.lat, data.lon]], {
                    color: '#3b82f6',
                    dashArray: '5, 10',
                    weight: 3,
                    opacity: 0.6
                }).addTo(map);
            }

            // Status Text
            const setStatus = (id, text, type) => {
                const el = document.getElementById(id);
                el.innerText = text;
                el.className = "text-[10px] px-1.5 py-0.5 rounded border ";
                if(type === 'good') el.classList.add("bg-green-500/10", "text-green-400", "border-green-500/20");
                else if(type === 'warn') el.classList.add("bg-yellow-500/10", "text-yellow-400", "border-yellow-500/20");
                else if(type === 'danger') el.classList.add("bg-red-500/10", "text-red-400", "border-red-500/20", "animate-pulse");
                else el.classList.add("bg-slate-800", "text-slate-400", "border-slate-700");
            };

            if (data.temp < 15) setStatus('status-temp', 'Cool', 'good');
            else if (data.temp <= 32) setStatus('status-temp', 'Optimal', 'good');
            else setStatus('status-temp', 'Hot', 'danger');

            if (data.hum < 30) setStatus('status-hum', 'Dry', 'warn');
            else if (data.hum <= 65) setStatus('status-hum', 'Ok', 'good');
            else setStatus('status-hum', 'Humid', 'warn');

            if (data.uv <= 2) setStatus('status-uv', 'Low', 'good');
            else if (data.uv <= 5) setStatus('status-uv', 'Mod', 'warn');
            else if (data.uv <= 7) setStatus('status-uv', 'High', 'warn');
            else setStatus('status-uv', 'Extreme', 'danger');

            if (data.gas <= 100) setStatus('status-gas', 'Good', 'good');
            else if (data.gas <= 250) setStatus('status-gas', 'Fair', 'warn');
            else setStatus('status-gas', 'Poor', 'danger');
        }

        function updateChartsHistory(historyData) {
            const labels = historyData.map(d => d.time ? d.time.split(' ')[1] || d.time : '');
            
            envChart.data.labels = labels;
            envChart.data.datasets[0].data = historyData.map(d => d.temp);
            envChart.data.datasets[1].data = historyData.map(d => d.hum);
            envChart.data.datasets[2].data = historyData.map(d => d.uv);
            envChart.data.datasets[3].data = historyData.map(d => d.gas);
            envChart.update();
        }

        window.onload = function() {
            initMap();
            initCharts();
            fetchData();
            
            // Interval to update status text (e.g. "Last seen X ago")
            setInterval(updateConnectionStatus, 1000);
            
            // Auto-refresh data every 3 seconds to keep dashboard live
            setInterval(fetchData, 3000);
        };
    </script>
</body>
</html>
