<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoSense Live Monitor</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a202c; 
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; 
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #718096; 
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        /* Map Height */
        #map {
            height: 400px;
            z-index: 1;
        }

        /* Card Transitions */
        .stat-card {
            transition: all 0.3s ease;
        }
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3);
        }

        /* Animation */
        @keyframes pulse-ring {
            0% { transform: scale(0.33); }
            80%, 100% { opacity: 0; }
        }
        @keyframes pulse-dot {
            0% { transform: scale(0.8); }
            50% { transform: scale(1); }
            100% { transform: scale(0.8); }
        }
    </style>
</head>
<body class="bg-slate-900 text-gray-100 font-sans min-h-screen selection:bg-blue-500 selection:text-white flex flex-col">

    <!-- Navbar -->
    <nav class="glass sticky top-0 z-50 border-b border-slate-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-blue-500 flex items-center justify-center animate-pulse">
                        <i class="fa-solid fa-satellite-dish text-white text-sm"></i>
                    </div>
                    <span class="font-bold text-xl tracking-wide">EcoSense<span class="text-blue-400">Live</span></span>
                </div>
                <div class="flex items-center gap-4 text-sm">
                    <span id="connection-status" class="flex items-center gap-2 text-green-400">
                        <span class="w-2 h-2 rounded-full bg-green-400"></span> Data Loaded
                    </span>
                    <span id="last-updated" class="text-slate-400 hidden sm:inline">Fetching timestamp...</span>
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex-grow">
        
        <!-- Status Overview Cards -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            
            <!-- Temperature -->
            <div id="card-temp" class="stat-card glass rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fa-solid fa-temperature-three-quarters text-6xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">Temperature</span>
                    <div class="flex items-end gap-2 mt-2">
                        <span id="val-temp" class="text-4xl font-bold">--</span>
                        <span class="text-xl text-slate-500 mb-1">°C</span>
                    </div>
                    <!-- Added Status Label -->
                    <span id="status-temp" class="text-xs mt-2 px-2 py-1 rounded bg-slate-800 inline-block w-fit">Waiting...</span>
                    <div class="mt-4 h-1 w-full bg-slate-700 rounded-full overflow-hidden">
                        <div id="bar-temp" class="h-full bg-blue-500 w-0 transition-all duration-1000"></div>
                    </div>
                </div>
            </div>

            <!-- Humidity -->
            <div id="card-hum" class="stat-card glass rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fa-solid fa-droplet text-6xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">Humidity</span>
                    <div class="flex items-end gap-2 mt-2">
                        <span id="val-hum" class="text-4xl font-bold">--</span>
                        <span class="text-xl text-slate-500 mb-1">%</span>
                    </div>
                    <!-- Added Status Label -->
                    <span id="status-hum" class="text-xs mt-2 px-2 py-1 rounded bg-slate-800 inline-block w-fit">Waiting...</span>
                    <div class="mt-4 h-1 w-full bg-slate-700 rounded-full overflow-hidden">
                        <div id="bar-hum" class="h-full bg-cyan-400 w-0 transition-all duration-1000"></div>
                    </div>
                </div>
            </div>

            <!-- UV Index -->
            <div id="card-uv" class="stat-card glass rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fa-regular fa-sun text-6xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">UV Index</span>
                    <div class="flex items-end gap-2 mt-2">
                        <span id="val-uv" class="text-4xl font-bold">--</span>
                        <span class="text-xl text-slate-500 mb-1">Idx</span>
                    </div>
                    <span id="status-uv" class="text-xs mt-2 px-2 py-1 rounded bg-slate-800 inline-block w-fit">Normal</span>
                </div>
            </div>

            <!-- Gas PPM -->
            <div id="card-gas" class="stat-card glass rounded-xl p-6 relative overflow-hidden group">
                <div class="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity">
                    <i class="fa-solid fa-wind text-6xl"></i>
                </div>
                <div class="flex flex-col">
                    <span class="text-slate-400 text-sm font-medium uppercase tracking-wider">Air Quality (Gas)</span>
                    <div class="flex items-end gap-2 mt-2">
                        <span id="val-gas" class="text-4xl font-bold">--</span>
                        <span class="text-xl text-slate-500 mb-1">PPM</span>
                    </div>
                    <span id="status-gas" class="text-xs mt-2 px-2 py-1 rounded bg-slate-800 inline-block w-fit">Safe</span>
                </div>
            </div>
        </div>

        <!-- Solar & Distance Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-4 gap-6 mb-8">
            <!-- Solar Stats (Takes up 3 cols on large) -->
            <div class="lg:col-span-3 glass rounded-xl p-6">
                <h3 class="text-lg font-semibold mb-6 flex items-center gap-2">
                    <i class="fa-solid fa-solar-panel text-yellow-500"></i> Solar Array Performance
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
                    <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">Voltage</p>
                        <p class="text-2xl font-bold text-yellow-400"><span id="val-sol-v">--</span> <span class="text-sm text-slate-500">V</span></p>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">Current</p>
                        <p class="text-2xl font-bold text-yellow-400"><span id="val-sol-i">--</span> <span class="text-sm text-slate-500">mA</span></p>
                    </div>
                    <div class="bg-slate-800/50 rounded-lg p-4 border border-slate-700">
                        <p class="text-xs text-slate-400 uppercase">Power Output</p>
                        <p class="text-2xl font-bold text-green-400"><span id="val-sol-p">--</span> <span class="text-sm text-slate-500">W</span></p>
                    </div>
                </div>
                <!-- Solar Chart -->
                <div class="mt-6 h-48 w-full">
                    <canvas id="solarChart"></canvas>
                </div>
            </div>

            <!-- Distance Card -->
            <div class="glass rounded-xl p-6 flex flex-col justify-between relative overflow-hidden">
                <div class="absolute -right-6 -bottom-6 w-32 h-32 bg-blue-500/20 rounded-full blur-2xl"></div>
                <div>
                    <h3 class="text-lg font-semibold mb-2 flex items-center gap-2">
                        <i class="fa-solid fa-ruler-horizontal text-blue-400"></i> Range
                    </h3>
                    <p class="text-slate-400 text-xs mb-4">Distance from Ground Station</p>
                </div>
                <div class="text-center py-4">
                    <span id="val-dist" class="text-5xl font-bold tracking-tighter text-white">--</span>
                    <span class="text-lg text-slate-400 block">Meters</span>
                </div>
                <div class="mt-2 text-xs text-center text-slate-500">
                    Lat: <span id="lbl-lat">--</span> <br> Lon: <span id="lbl-lon">--</span>
                </div>
            </div>
        </div>

        <!-- Charts & Map Row -->
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            
            <!-- Environmental Chart -->
            <div class="glass rounded-xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-chart-line text-purple-400"></i> Environmental Trends
                    </h3>
                    <div class="flex gap-2 text-xs flex-wrap">
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-red-400"></span> Temp</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-400"></span> Hum</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-green-400"></span> Gas</span>
                        <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-yellow-400"></span> UV</span>
                    </div>
                </div>
                <div class="h-80 w-full">
                    <canvas id="envChart"></canvas>
                </div>
            </div>

            <!-- Map -->
            <div class="glass rounded-xl p-1 overflow-hidden flex flex-col">
                <div class="p-4 bg-slate-800/50 flex justify-between items-center">
                    <h3 class="text-lg font-semibold flex items-center gap-2">
                        <i class="fa-solid fa-location-dot text-red-500"></i> GPS Tracking
                    </h3>
                    <span class="text-xs bg-blue-600 px-2 py-1 rounded text-white">LIVE LOC</span>
                </div>
                <div id="map" class="flex-grow w-full h-full rounded-b-lg bg-slate-800 relative">
                    <!-- Map Loads Here -->
                </div>
            </div>

        </div>
    </main>

    <!-- Footer -->
    <footer class="border-t border-slate-800 mt-12 py-8 text-center text-slate-500 text-sm">
        <p class="mb-2">EcoSense Dashboard &copy; 2023. Real-time Environmental Monitoring System.</p>
        <p>
            Designed and developed by 
            <a href="https://jabedshariar.vercel.app" target="_blank" class="text-blue-400 hover:text-blue-300 underline underline-offset-2 transition-colors">Jabed Shariar</a>
        </p>
    </footer>

    <script>
        // --- Configuration ---
        const SHEET_URL = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQie58TDrdruTe_9HevG5NGowDAix8Q0tzG2qYL26AooSA9WlRPiLFmmWFYrc82DA/pub?output=csv";
        
        // Ground Station Coordinates (Fixed)
        const GS_LAT = 23.88134963936152;
        const GS_LON = 90.32049486826592;

        // --- State ---
        let map, mobileMarker, groundMarker, polyline;
        let envChart, solarChart;
        let isFirstLoad = true;

        // --- Chart Initialization ---
        function initCharts() {
            // Environmental Chart (Temp, Hum, Gas, UV)
            const ctxEnv = document.getElementById('envChart').getContext('2d');
            envChart = new Chart(ctxEnv, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Temp (°C)', borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.1)', data: [], tension: 0.4, yAxisID: 'y' },
                        { label: 'Humidity (%)', borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', data: [], tension: 0.4, yAxisID: 'y' },
                        { label: 'UV Index', borderColor: '#facc15', borderDash: [5, 5], data: [], tension: 0.4, yAxisID: 'y' },
                        { label: 'Gas (PPM)', borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.05)', data: [], tension: 0.4, fill: true, yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { 
                            type: 'linear',
                            display: true,
                            position: 'left',
                            grid: { color: 'rgba(255,255,255,0.05)' }, 
                            ticks: { color: '#94a3b8' } 
                        },
                        y1: { 
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { display: false }, 
                            ticks: { color: '#10b981' },
                            title: { display: true, text: 'Gas PPM', color: '#10b981', font: {size: 10} }
                        }
                    }
                }
            });

            // Solar Chart (Power, Voltage, Current)
            const ctxSolar = document.getElementById('solarChart').getContext('2d');
            solarChart = new Chart(ctxSolar, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'Power (W)', backgroundColor: '#22c55e', data: [], yAxisID: 'y' },
                        { label: 'Voltage (V)', backgroundColor: '#eab308', data: [], yAxisID: 'y' },
                        { label: 'Current (mA)', type: 'line', borderColor: '#3b82f6', borderDash: [5,5], data: [], yAxisID: 'y1' }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: true, labels: { color: '#cbd5e1', font: {size: 10} } } },
                    scales: {
                        x: { display: false },
                        y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                        y1: { 
                            position: 'right', 
                            grid: { display: false }, 
                            ticks: { color: '#3b82f6' },
                            title: { display: true, text: 'mA', color: '#3b82f6', font: {size: 10} }
                        }
                    }
                }
            });
        }

        // --- Map Initialization ---
        function initMap() {
            map = L.map('map').setView([GS_LAT, GS_LON], 15);

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap contributors &copy; CARTO',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(map);

            // Ground Station
            const gsIcon = L.divIcon({
                className: 'custom-div-icon',
                html: "<div style='background-color:#3b82f6; width:12px; height:12px; border-radius:50%; border:2px solid white; box-shadow: 0 0 10px #3b82f6;'></div>",
                iconSize: [12, 12],
                iconAnchor: [6, 6]
            });
            groundMarker = L.marker([GS_LAT, GS_LON], { icon: gsIcon }).addTo(map)
                .bindPopup("Ground Station").openPopup();

            // Mobile Station
            const msIcon = L.divIcon({
                className: 'custom-div-icon',
                html: `<div style="position: relative;">
                         <div style="position: absolute; width: 20px; height: 20px; background: rgba(239, 68, 68, 0.4); border-radius: 50%; animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;"></div>
                         <div style="position: absolute; top: 5px; left: 5px; width: 10px; height: 10px; background: #ef4444; border-radius: 50%; border: 2px solid white; animation: pulse-dot 1.5s cubic-bezier(0.455, 0.03, 0.515, 0.955) -.4s infinite;"></div>
                       </div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            mobileMarker = L.marker([GS_LAT, GS_LON], { icon: msIcon }).addTo(map);
        }

        // --- Haversine Distance ---
        function getDistanceFromLatLonInM(lat1, lon1, lat2, lon2) {
            const R = 6371000; 
            const dLat = deg2rad(lat2 - lat1);
            const dLon = deg2rad(lon2 - lon1);
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                      Math.sin(dLon / 2) * Math.sin(dLon / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return Math.floor(R * c); 
        }

        function deg2rad(deg) { return deg * (Math.PI / 180); }

        // --- Data Fetching ---
        async function fetchData() {
            try {
                // cache_buster ensures we get fresh data from Google's servers on every page reload
                const response = await fetch(SHEET_URL + "&cache_buster=" + Date.now(), {
                    cache: 'no-store'
                });

                if (!response.ok) throw new Error("Network response was not ok");
                const text = await response.text();
                
                // Parse CSV
                const rows = text.split('\n').map(row => row.split(','));
                
                // Filter valid rows (must have content)
                const dataRows = rows.filter(r => r.join('').trim().length > 0);
                
                if (dataRows.length < 2) {
                    console.warn("No data found.");
                    return;
                }

                // Get Headers (Row 0) and Last Row (Latest Data)
                const headers = dataRows[0].map(h => h.trim()); // Case sensitive based on prompt
                const lastRow = dataRows[dataRows.length - 1];

                // Helper to get data by exact header name
                const getVal = (headerName) => {
                    const idx = headers.indexOf(headerName);
                    if (idx === -1) return 0; // Header not found
                    let val = lastRow[idx];
                    if (typeof val === 'string') val = val.replace(/"/g, '').trim();
                    return val; 
                };

                // --- Extract Data based on SPECIFIC Headers ---
                // Timestamp Latitude Longitude Temperature_C Humidity_% Gas_PPM UV_Index Solar_Voltage_V Solar_Current_mA
                const timestampStr = getVal('Timestamp');
                const lat = parseFloat(getVal('Latitude')) || GS_LAT;
                const lon = parseFloat(getVal('Longitude')) || GS_LON;
                const temp = parseFloat(getVal('Temperature_C')) || 0;
                const hum = parseFloat(getVal('Humidity_%')) || 0;
                const gas = parseFloat(getVal('Gas_PPM')) || 0;
                const uv = parseFloat(getVal('UV_Index')) || 0;
                const solV = parseFloat(getVal('Solar_Voltage_V')) || 0;
                const solI = parseFloat(getVal('Solar_Current_mA')) || 0; // In mA

                // Calculate Power (W) = V * (mA / 1000)
                const solP = (solV * (solI / 1000)).toFixed(2);

                const dataObj = { timestampStr, lat, lon, temp, hum, gas, uv, solV, solI, solP };

                updateUI(dataObj);
                
                // For charts, we ideally want history. In this static fetch, we usually only get the last row easily 
                // unless we map the whole array. Let's map the last 20 rows for the chart.
                const history = dataRows.slice(-20).map(row => {
                    const getRowVal = (name) => {
                         const i = headers.indexOf(name);
                         return i !== -1 ? parseFloat(row[i]) : 0;
                    };
                    return {
                        time: row[headers.indexOf('Timestamp')],
                        temp: getRowVal('Temperature_C'),
                        hum: getRowVal('Humidity_%'),
                        gas: getRowVal('Gas_PPM'),
                        uv: getRowVal('UV_Index'),
                        solV: getRowVal('Solar_Voltage_V'),
                        solI: getRowVal('Solar_Current_mA'),
                        solP: (getRowVal('Solar_Voltage_V') * (getRowVal('Solar_Current_mA')/1000)).toFixed(2)
                    };
                });
                
                updateChartsHistory(history);

            } catch (error) {
                console.error("Fetch error:", error);
                document.getElementById('connection-status').innerHTML = `<span class="w-2 h-2 rounded-full bg-red-500"></span> Error Loading`;
            }
        }

        function updateUI(data) {
            // Text Updates
            document.getElementById('val-temp').innerText = data.temp;
            document.getElementById('val-hum').innerText = data.hum;
            document.getElementById('val-uv').innerText = data.uv;
            document.getElementById('val-gas').innerText = data.gas;
            document.getElementById('val-sol-v').innerText = data.solV;
            document.getElementById('val-sol-i').innerText = data.solI;
            document.getElementById('val-sol-p').innerText = data.solP;
            document.getElementById('lbl-lat').innerText = data.lat.toFixed(6);
            document.getElementById('lbl-lon').innerText = data.lon.toFixed(6);
            
            // Timestamp from Sheet
            document.getElementById('last-updated').innerText = "Last Updated: " + (data.timestampStr || "Unknown");

            // Progress Bars
            document.getElementById('bar-temp').style.width = Math.min((data.temp / 50) * 100, 100) + '%';
            document.getElementById('bar-hum').style.width = Math.min(data.hum, 100) + '%';

            // Distance
            const dist = getDistanceFromLatLonInM(GS_LAT, GS_LON, data.lat, data.lon);
            document.getElementById('val-dist').innerText = dist;

            // Map
            if (mobileMarker) {
                const newLatLng = new L.LatLng(data.lat, data.lon);
                mobileMarker.setLatLng(newLatLng);
                if (isFirstLoad && data.lat !== 0) {
                    map.panTo(newLatLng);
                    isFirstLoad = false;
                }
                if (polyline) map.removeLayer(polyline);
                polyline = L.polyline([[GS_LAT, GS_LON], [data.lat, data.lon]], {
                    color: 'rgba(59, 130, 246, 0.5)',
                    dashArray: '5, 10',
                    weight: 2
                }).addTo(map);
            }

            // --- QUALITY JUDGEMENTS ---
            
            // Helper for setting status text & color
            const setStatus = (id, text, type) => {
                const el = document.getElementById(id);
                el.innerText = text;
                // Reset classes then add base + type specific
                el.className = "text-xs mt-2 px-2 py-1 rounded inline-block w-fit ";
                if(type === 'good') el.classList.add("bg-green-600/20", "text-green-400", "border", "border-green-600/30");
                else if(type === 'warn') el.classList.add("bg-yellow-600/20", "text-yellow-400", "border", "border-yellow-600/30");
                else if(type === 'danger') el.classList.add("bg-red-600/20", "text-red-400", "border", "border-red-600/30", "animate-pulse");
                else el.classList.add("bg-slate-800", "text-gray-300"); // neutral
            };

            // 1. Temperature Judgment
            const barTemp = document.getElementById('bar-temp');
            if (data.temp < 15) {
                setStatus('status-temp', 'Cool', 'good');
                barTemp.className = "h-full bg-cyan-500 w-0 transition-all duration-1000";
            } else if (data.temp >= 15 && data.temp <= 32) {
                setStatus('status-temp', 'Optimal', 'good');
                barTemp.className = "h-full bg-green-500 w-0 transition-all duration-1000";
            } else {
                setStatus('status-temp', 'Hot', 'danger');
                barTemp.className = "h-full bg-orange-500 w-0 transition-all duration-1000";
            }

            // 2. Humidity Judgment
            if (data.hum < 30) {
                setStatus('status-hum', 'Dry', 'warn');
            } else if (data.hum >= 30 && data.hum <= 65) {
                setStatus('status-hum', 'Comfortable', 'good');
            } else {
                setStatus('status-hum', 'High Humidity', 'warn');
            }

            // 3. UV Judgment
            const cardUV = document.getElementById('card-uv');
            cardUV.className = `stat-card glass rounded-xl p-6 relative overflow-hidden group`; // Reset
            if (data.uv <= 2) {
                setStatus('status-uv', 'Low', 'good');
            } else if (data.uv > 2 && data.uv <= 5) {
                setStatus('status-uv', 'Moderate', 'warn');
                cardUV.classList.add('border-yellow-500', 'bg-yellow-500/5');
            } else if (data.uv > 5 && data.uv <= 7) {
                setStatus('status-uv', 'High', 'warn');
                cardUV.classList.add('border-orange-500', 'bg-orange-500/5');
            } else {
                setStatus('status-uv', 'Danger', 'danger');
                cardUV.classList.add('border-red-500', 'bg-red-500/10');
            }

            // 4. Gas Judgment
            const cardGas = document.getElementById('card-gas');
            cardGas.className = `stat-card glass rounded-xl p-6 relative overflow-hidden group`;
            if (data.gas <= 100) {
                setStatus('status-gas', 'Excellent', 'good');
            } else if (data.gas > 100 && data.gas <= 250) {
                setStatus('status-gas', 'Moderate', 'warn');
            } else {
                setStatus('status-gas', 'Hazardous', 'danger');
                cardGas.classList.add('border-red-500', 'bg-red-500/10');
            }

            // Solar Judgments Removed as requested
        }

        function updateChartsHistory(historyData) {
            // Arrays for Chart.js
            const labels = historyData.map(d => {
                // Formatting time briefly (e.g. "10:30:05") if timestamp is full date string
                return d.time ? d.time.split(' ')[1] || d.time : '';
            });

            // Env Chart Update
            envChart.data.labels = labels;
            envChart.data.datasets[0].data = historyData.map(d => d.temp);
            envChart.data.datasets[1].data = historyData.map(d => d.hum);
            envChart.data.datasets[2].data = historyData.map(d => d.uv);
            envChart.data.datasets[3].data = historyData.map(d => d.gas);
            envChart.update();

            // Solar Chart Update
            solarChart.data.labels = labels;
            solarChart.data.datasets[0].data = historyData.map(d => d.solP);
            solarChart.data.datasets[1].data = historyData.map(d => d.solV);
            solarChart.data.datasets[2].data = historyData.map(d => d.solI);
            solarChart.update();
        }

        // --- Lifecycle ---
        window.onload = function() {
            initMap();
            initCharts();
            // Fetch once on load (user must refresh page to get new data)
            fetchData();
        };

    </script>
</body>
</html>
